<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alliance Points Calculator</title>

  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root { color-scheme: light dark; }

    *, *::before, *::after { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      padding: 18px;
      display: flex;
      justify-content: center;
    }

    .container {
      --ui: 1;
      width: 100%;
      max-width: calc(560px * var(--ui));
      display: flex;
      flex-direction: column;
      gap: calc(14px * var(--ui));
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: calc(10px * var(--ui));
    }

    h1 {
      font-size: calc(20px * var(--ui));
      margin: 0;
      line-height: 1.2;
      text-align: center;
    }

    .scaleControls {
      display: flex;
      gap: calc(8px * var(--ui));
    }

    .scaleBtn {
      width: calc(36px * var(--ui));
      height: calc(36px * var(--ui));
      border-radius: calc(10px * var(--ui));
      border: 1px solid rgba(127,127,127,0.45);
      background: rgba(127,127,127,0.10);
      font-size: calc(18px * var(--ui));
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .scaleBtn:active {
      transform: translateY(1px);
    }

    .card {
      border: 1px solid rgba(127,127,127,0.35);
      border-radius: calc(14px * var(--ui));
      padding: calc(16px * var(--ui));
      display: flex;
      flex-direction: column;
      gap: calc(14px * var(--ui));
    }

    label {
      display: flex;
      flex-direction: column;
      gap: calc(8px * var(--ui));
      font-size: calc(15px * var(--ui));
    }

    input {
      width: 100%;
      padding: calc(14px * var(--ui));
      font-size: calc(18px * var(--ui));
      border-radius: calc(12px * var(--ui));
      border: 1px solid rgba(127,127,127,0.45);
      outline: none;
      background: transparent;
    }

    input:focus {
      border-color: rgba(80, 120, 255, 0.9);
      box-shadow: 0 0 0 calc(3px * var(--ui)) rgba(80, 120, 255, 0.25);
    }

    .result {
      font-weight: 800;
      font-size: calc(16px * var(--ui));
      line-height: 1.35;
      padding: calc(14px * var(--ui));
      border-radius: calc(12px * var(--ui));
      background: rgba(127,127,127,0.12);
      border: 1px solid rgba(127,127,127,0.25);
      text-align: center;
    }

    .hint {
      font-size: calc(13px * var(--ui));
      opacity: 0.85;
      line-height: 1.35;
      text-align: center;
    }

    .actions {
      display: flex;
      gap: calc(10px * var(--ui));
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
    }

    .primaryBtn {
      padding: calc(12px * var(--ui)) calc(14px * var(--ui));
      font-size: calc(15px * var(--ui));
      font-weight: 800;
      border-radius: calc(12px * var(--ui));
      border: 1px solid rgba(127,127,127,0.45);
      background: rgba(80, 120, 255, 0.18);
      cursor: pointer;
    }

    .primaryBtn:active {
      transform: translateY(1px);
    }

    .primaryBtn:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }

    .countdownBox {
      padding: calc(12px * var(--ui));
      border-radius: calc(12px * var(--ui));
      border: 1px solid rgba(127,127,127,0.25);
      background: rgba(127,127,127,0.08);
      text-align: center;
      font-size: calc(14px * var(--ui));
      line-height: 1.35;
    }

    .muted {
      opacity: 0.85;
      font-weight: 650;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    function parseAbbrevNumber(raw) {
      // Accepts: "90k", "1.5M", "2B", "90000"
      if (raw == null) return NaN;
      const s0 = String(raw).trim();
      if (s0 === "") return NaN;

      const s = s0.replace(",", ".");
      const match = s.match(/^([0-9]+(?:\.[0-9]+)?)\s*([kKmMbB])?$/);
      if (!match) return NaN;

      const value = Number(match[1]);
      if (!Number.isFinite(value)) return NaN;

      const suffix = match[2] || "";
      let mult = 1;
      if (suffix === "k" || suffix === "K") mult = 1_000;
      else if (suffix === "M" || suffix === "m") mult = 1_000_000;
      else if (suffix === "B" || suffix === "b") mult = 1_000_000_000;

      return value * mult;
    }

    function formatDuration(totalMinutes) {
      const h = Math.floor(totalMinutes / 60);
      const m = totalMinutes % 60;

      if (h === 0) return `${m} minute(s).`;
      if (m === 0) return `${h} hour(s).`;
      return `${h} hour(s) and ${m} minute(s).`;
    }

    function pad2(n) {
      return String(n).padStart(2, "0");
    }

    function formatHHMM(date) {
      const h = pad2(date.getHours());
      const m = pad2(date.getMinutes());
      return `${h}:${m}`;
    }

    function computeMinutes(rate, current, target) {
      const r = parseAbbrevNumber(rate);
      const c = parseAbbrevNumber(current);
      const t = parseAbbrevNumber(target);

      if (!Number.isFinite(r) || !Number.isFinite(c) || !Number.isFinite(t)) {
        return { ok: false, message: "Enter all values (e.g. 9.25k, 1.5M, 2B)." };
      }
      if (r <= 0) {
        return { ok: false, message: "Production rate must be strictly positive." };
      }
      if (t <= c) {
        return { ok: false, message: "Target amount already reached." };
      }

      const hours = (t - c) / r;
      const totalMinutes = Math.ceil(hours * 60);

      return { ok: true, totalMinutes };
    }

    function App() {
      const [rate, setRate] = React.useState("");
      const [current, setCurrent] = React.useState("");
      const [target, setTarget] = React.useState("");

      const [uiScale, setUiScale] = React.useState(1.15);
      const MIN_SCALE = 0.9;
      const MAX_SCALE = 1.6;
      const STEP = 0.05;

      // Countdown state
      const [countdownActive, setCountdownActive] = React.useState(false);
      const [endTs, setEndTs] = React.useState(null); // number (ms since epoch)
      const [startMinutes, setStartMinutes] = React.useState(null); // minutes fixed at click
      const [remainingMinutes, setRemainingMinutes] = React.useState(null);

      const intervalRef = React.useRef(null);

      function computeText() {
        const res = computeMinutes(rate, current, target);
        if (!res.ok) return res.message;
        return `Time required: ${formatDuration(res.totalMinutes)}`;
      }

      function stopCountdown() {
        if (intervalRef.current) {
          clearInterval(intervalRef.current);
          intervalRef.current = null;
        }
        setCountdownActive(false);
        setEndTs(null);
        setStartMinutes(null);
        setRemainingMinutes(null);
      }

      function tickCountdown(endTimestampMs) {
        const now = Date.now();
        const remainingMs = Math.max(0, endTimestampMs - now);
        const remMin = Math.ceil(remainingMs / 60000); // minute-precision display
        setRemainingMinutes(remMin);

        if (remainingMs <= 0) {
          // ensure we stop cleanly before alert
          if (intervalRef.current) {
            clearInterval(intervalRef.current);
            intervalRef.current = null;
          }
          setCountdownActive(false);
          setRemainingMinutes(0);
          window.alert("Countdown finished: target should be reached now.");
        }
      }

      function startCountdown() {
        const res = computeMinutes(rate, current, target);
        if (!res.ok) {
          window.alert(res.message);
          return;
        }

        // Restart from zero on every click (your requirement)
        if (intervalRef.current) {
          clearInterval(intervalRef.current);
          intervalRef.current = null;
        }

        const minutes = res.totalMinutes;
        const endTimestampMs = Date.now() + minutes * 60 * 1000;

        setCountdownActive(true);
        setStartMinutes(minutes);
        setEndTs(endTimestampMs);

        // Set immediately, then update regularly
        tickCountdown(endTimestampMs);

        intervalRef.current = setInterval(() => {
          tickCountdown(endTimestampMs);
        }, 1000);
      }

      // Cleanup on unmount
      React.useEffect(() => {
        return () => {
          if (intervalRef.current) clearInterval(intervalRef.current);
        };
      }, []);

      function decScale() {
        setUiScale(s => Math.max(MIN_SCALE, Math.round((s - STEP) * 100) / 100));
      }
      function incScale() {
        setUiScale(s => Math.min(MAX_SCALE, Math.round((s + STEP) * 100) / 100));
      }

      const countdownEndText = endTs ? formatHHMM(new Date(endTs)) : null;

      return (
        <div className="container" style={{ "--ui": uiScale }}>
          <div className="header">
            <h1>Alliance Points Calculator</h1>
            <div className="scaleControls">
              <button className="scaleBtn" onClick={decScale} type="button" title="Decrease">−</button>
              <button className="scaleBtn" onClick={incScale} type="button" title="Increase">+</button>
            </div>
          </div>

          <div className="card">
            <label>
              Production rate (points / hour)
              <input
                type="text"
                inputMode="decimal"
                value={rate}
                onChange={e => setRate(e.target.value)}
                placeholder="e.g. 9.25k"
              />
            </label>

            <label>
              Current alliance points
              <input
                type="text"
                inputMode="decimal"
                value={current}
                onChange={e => setCurrent(e.target.value)}
                placeholder="e.g. 1.2M"
              />
            </label>

            <label>
              Target alliance points
              <input
                type="text"
                inputMode="decimal"
                value={target}
                onChange={e => setTarget(e.target.value)}
                placeholder="e.g. 2M"
              />
            </label>

            <div className="result">{computeText()}</div>

            <div className="actions">
              <button className="primaryBtn" type="button" onClick={startCountdown}>
                Start countdown
              </button>

              {countdownActive && (
                <button className="primaryBtn" type="button" onClick={stopCountdown}>
                  Stop
                </button>
              )}
            </div>

            {(countdownActive || endTs) && (
              <div className="countdownBox">
                {startMinutes != null && (
                  <div className="muted">Fixed duration at start: {formatDuration(startMinutes)}</div>
                )}
                {remainingMinutes != null && (
                  <div style={{ marginTop: "6px", fontWeight: 900 }}>
                    Countdown: {remainingMinutes} minute(s) remaining
                  </div>
                )}
                {countdownEndText && (
                  <div style={{ marginTop: "6px" }}>
                    Ends at: <b>{countdownEndText}</b>
                  </div>
                )}
              </div>
            )}

            <div className="hint">
              Supported suffixes: <b>k</b>=1,000 · <b>M</b>=1,000,000 · <b>B</b>=1,000,000,000<br />
              Examples: 90k, 1.5M, 2B
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
